(window.webpackJsonp=window.webpackJsonp||[]).push([[17],{UQSp:function(e,t,a){"use strict";t.a={name:"VueRemarkRoot",render:function(e){return e("div",null,this.$slots.default)}}},bdOh:function(e,t,a){"use strict";a.r(t);var s=a("7uw+"),n=a("UQSp"),r=a("oCYn");function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}r.default.config.optionMergeStrategies;var i={VueRemarkRoot:n.a},l=function(e){var t=e.options.components=e.options.components||{},a=e.options.computed=e.options.computed||{};Object.keys(i).forEach((function(e){"object"===o(i[e])&&"function"==typeof i[e].render||"function"==typeof i[e]&&"function"==typeof i[e].options.render?t[e]=i[e]:a[e]=function(){return i[e]}}))},c=r.default.config.optionMergeStrategies,p="__vueRemarkFrontMatter",h={excerpt:null,weight:5,"tree-title":"th2 infra",readme:"https://raw.githubusercontent.com/th2-net/th2-infra/master/README.md",title:"th2 installation"};var v=function(e){e.options[p]&&(e.options[p]=h),r.default.util.defineReactive(e.options,p,h),e.options.computed=c.computed({$frontmatter:function(){return e.options[p]}},e.options.computed)},u=Object(s.a)({},(function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("VueRemarkRoot",[a("h1",{attrs:{id:"th2-installation"}},[a("a",{attrs:{href:"#th2-installation","aria-hidden":"true"}},[e._v("#")]),e._v("th2 installation")]),a("h2",{attrs:{id:"prerequisites"}},[a("a",{attrs:{href:"#prerequisites","aria-hidden":"true"}},[e._v("#")]),e._v("Prerequisites")]),a("p",[e._v("Before you begin, please check the following prerequisites:")]),a("ul",[a("li",[e._v("Fully functioning Kubernetes cluster suitable for your bussiness needs, please refer to "),a("a",{attrs:{href:"https://github.com/th2-net/th2-documentation/wiki/Technical-Requirements",target:"_blank",rel:"nofollow noopener noreferrer"}},[e._v("technical requirements")]),e._v(" and "),a("a",{attrs:{href:"https://github.com/th2-net/th2-infra/blob/compatibility-docs/docs/COMPATIBILITY.md",target:"_blank",rel:"nofollow noopener noreferrer"}},[e._v("version compatibility")])]),a("li",[e._v("Operator-box that meets "),a("a",{attrs:{href:"https://github.com/th2-net/th2-documentation/wiki/Technical-Requirements",target:"_blank",rel:"nofollow noopener noreferrer"}},[e._v("hardware")]),e._v(" and "),a("a",{attrs:{href:"https://github.com/th2-net/th2-documentation/wiki/Technical-Requirements#software-requirements",target:"_blank",rel:"nofollow noopener noreferrer"}},[e._v("software")]),e._v(" requirements")]),a("li",[e._v("Installed "),a("a",{attrs:{href:"https://cassandra.apache.org/",target:"_blank",rel:"nofollow noopener noreferrer"}},[e._v("Apache Cassandra")]),e._v(" - "),a("a",{attrs:{href:"https://github.com/th2-net/th2-documentation/wiki/Technical-Requirements#apache-cassandra-cluster-hardware-requirements",target:"_blank",rel:"nofollow noopener noreferrer"}},[e._v("technical requirements")])])]),a("p",[e._v("All th2 components are deployed via Helm charts by "),a("a",{attrs:{href:"https://helm.sh/",target:"_blank",rel:"nofollow noopener noreferrer"}},[e._v("Helm")]),e._v(" and "),a("a",{attrs:{href:"https://docs.fluxcd.io/projects/helm-operator/en/stable/",target:"_blank",rel:"nofollow noopener noreferrer"}},[e._v("Helm Operator")]),e._v(".")]),a("h2",{attrs:{id:"steps"}},[a("a",{attrs:{href:"#steps","aria-hidden":"true"}},[e._v("#")]),e._v("Steps")]),a("p",[e._v("The following steps should be performed on the operator-box for th2-infra deployment:")]),a("ul",[a("li",[a("a",{attrs:{href:"#th2-git-repository"}},[e._v("Download th2 git repositories")])]),a("li",[a("a",{attrs:{href:"#monitoring-deployment"}},[e._v("Monitoring deployment")])]),a("li",[a("a",{attrs:{href:"#cluster-configuration"}},[e._v("Cluster configuration")])]),a("li",[a("a",{attrs:{href:"#th2-deployment"}},[e._v("th2 deployment")])])]),a("h2",{attrs:{id:"th2-git-repository"}},[a("a",{attrs:{href:"#th2-git-repository","aria-hidden":"true"}},[e._v("#")]),e._v("th2 git repository")]),a("p",[e._v("Installation of th2 infra requires a Git repository for maintaining th2 schema configuration. The information regarding this repository and its usage can be found in the guide further.")]),a("p",[a("a",{attrs:{href:"https://github.com/th2-net/th2-infra-schema-demo",target:"_blank",rel:"nofollow noopener noreferrer"}},[e._v("https://github.com/th2-net/th2-infra-schema-demo")]),e._v(" - can be used as a starter kit for schema repository.\n"),a("a",{attrs:{href:"https://docs.github.com/en/free-pro-team@latest/github/creating-cloning-and-archiving-repositories/creating-a-repository-from-a-template",target:"_blank",rel:"nofollow noopener noreferrer"}},[e._v("Template")]),e._v(" or "),a("a",{attrs:{href:"https://docs.github.com/en/free-pro-team@latest/github/getting-started-with-github/fork-a-repo#fork-an-example-repository",target:"_blank",rel:"nofollow noopener noreferrer"}},[e._v("fork")]),e._v(" it.")]),a("p",[a("a",{attrs:{href:"https://github.com/th2-net/th2-infra/tree/master/example-values",target:"_blank",rel:"nofollow noopener noreferrer"}},[e._v("https://github.com/th2-net/th2-infra/example-values")]),e._v(" - contains example values for th2 infra charts, we also recommend to store these values in a separate git repository")]),a("p",[e._v("Clone th2-infra values repository into your operator-box:")]),a("div",{staticClass:"remark-highlight"},[a("pre",{staticClass:"language-shell"},[a("code",{staticClass:"language-shell"},[e._v("$ "),a("span",{staticClass:"token function"},[e._v("git")]),e._v(" clone https://github.com/th2-net/th2-infra.git\n")])]),a("copy-code-btn")],1),a("p",[e._v("change the current directory")]),a("div",{staticClass:"remark-highlight"},[a("pre",{staticClass:"language-shell"},[a("code",{staticClass:"language-shell"},[e._v("$ "),a("span",{staticClass:"token builtin class-name"},[e._v("cd")]),e._v(" ./th2-infra/example-values\n")])]),a("copy-code-btn")],1),a("h2",{attrs:{id:"infrastructure-namespaces"}},[a("a",{attrs:{href:"#infrastructure-namespaces","aria-hidden":"true"}},[e._v("#")]),e._v("Infrastructure namespaces")]),a("p",[e._v("Infrastructure components are split into two namespaces: "),a("em",[a("code",{pre:!0},[e._v("monitoring")])]),e._v(" and "),a("em",[a("code",{pre:!0},[e._v("service")])]),e._v(". These namespaces will be created below.")]),a("p",[e._v("Next components of monitoring stack are deployed into "),a("em",[a("code",{pre:!0},[e._v("monitoring")])]),e._v(" namespace:")]),a("ul",[a("li",[a("a",{attrs:{href:"https://grafana.com/oss/grafana/",target:"_blank",rel:"nofollow noopener noreferrer"}},[e._v("grafana")])]),a("li",[a("a",{attrs:{href:"https://grafana.com/oss/loki/",target:"_blank",rel:"nofollow noopener noreferrer"}},[e._v("loki")])]),a("li",[a("a",{attrs:{href:"https://grafana.com/oss/prometheus/",target:"_blank",rel:"nofollow noopener noreferrer"}},[e._v("prometheus")])])]),a("p",[e._v("The "),a("em",[a("code",{pre:!0},[e._v("service")])]),e._v(" namespace is used for infrastructure services:")]),a("ul",[a("li",[a("a",{attrs:{href:"https://kubernetes.io/docs/tasks/access-application-cluster/web-ui-dashboard/",target:"_blank",rel:"nofollow noopener noreferrer"}},[e._v("kubernetes-dashboard")])]),a("li",[a("a",{attrs:{href:"https://www.rabbitmq.com/",target:"_blank",rel:"nofollow noopener noreferrer"}},[e._v("RabbitMQ")])]),a("li",[a("a",{attrs:{href:"https://kubernetes.github.io/ingress-nginx/",target:"_blank",rel:"nofollow noopener noreferrer"}},[e._v("NGINX Ingress Controller")])]),a("li",[a("a",{attrs:{href:"https://github.com/fluxcd/helm-operator",target:"_blank",rel:"nofollow noopener noreferrer"}},[e._v("Helm Operator")])])]),a("p",[e._v("and for th2-infra components:")]),a("ul",[a("li",[a("a",{attrs:{href:"https://github.com/th2-net/th2-infra-editor-v2",target:"_blank",rel:"nofollow noopener noreferrer"}},[e._v("th2-infra-editor")])]),a("li",[a("a",{attrs:{href:"https://github.com/th2-net/th2-infra-operator",target:"_blank",rel:"nofollow noopener noreferrer"}},[e._v("th2-infra-operator")])]),a("li",[a("a",{attrs:{href:"https://github.com/th2-net/th2-infra-mgr",target:"_blank",rel:"nofollow noopener noreferrer"}},[e._v("th2-infra-mgr")])]),a("li",[a("a",{attrs:{href:"https://github.com/th2-net/infra-operator-tpl",target:"_blank",rel:"nofollow noopener noreferrer"}},[e._v("th2-infra-repo")])])]),a("p",[e._v("The following picture describes a cluser with monitoring stack, th2-infra and th2 namespace:")]),a("p",[a("img",{attrs:{src:"https://user-images.githubusercontent.com/690243/101762881-0925d080-3aef-11eb-9d15-70e9277b0fa5.jpg",alt:"k8s cluster"}})]),a("h3",{attrs:{id:"create-namespaces"}},[a("a",{attrs:{href:"#create-namespaces","aria-hidden":"true"}},[e._v("#")]),e._v("Create namespaces:")]),a("div",{staticClass:"remark-highlight"},[a("pre",{staticClass:"language-shell"},[a("code",{staticClass:"language-shell"},[e._v("$ kubectl create namespace monitoring\nnamespace/monitoring created\n$ kubectl create namespace "),a("span",{staticClass:"token function"},[e._v("service")]),e._v("\nnamespace/service created\n")])]),a("copy-code-btn")],1),a("h2",{attrs:{id:"data-persistence"}},[a("a",{attrs:{href:"#data-persistence","aria-hidden":"true"}},[e._v("#")]),e._v("Data persistence")]),a("p",[e._v("Data persistence is required for the following components: Grafana, Prometheus, Loki, RabbitMQ components and should be set up on this step.")]),a("p",[a("em",[e._v("Note: Examples below use HostPath type of "),a("a",{attrs:{href:"https://kubernetes.io/docs/concepts/storage/persistent-volumes/",target:"_blank",rel:"nofollow noopener noreferrer"}},[e._v("Persistent Volume(PV)")]),e._v(". Please read the documentation to choose an appropriate PV type for your environment")])]),a("ul",[a("li",[e._v("the following command can require root permissions, create directory on th2 node:")])]),a("div",{staticClass:"remark-highlight"},[a("pre",{staticClass:"language-shell"},[a("code",{staticClass:"language-shell"},[e._v("$ "),a("span",{staticClass:"token function"},[e._v("mkdir")]),e._v(" /opt/grafana /opt/prometheus /opt/loki /opt/rabbitmq  /opt/jupiter_users /opt/jupiter_db\n")])]),a("copy-code-btn")],1),a("ul",[a("li",[e._v("set node name in "),a("code",{pre:!0},[e._v("pvs.yaml")])]),a("li",[e._v("create PVs and PVCs:")])]),a("div",{staticClass:"remark-highlight"},[a("pre",{staticClass:"language-shell"},[a("code",{staticClass:"language-shell"},[e._v("$ kubectl apply -f ./pvs.yaml\n$ kubectl apply -f ./pvcs.yaml\n")])]),a("copy-code-btn")],1),a("p",[e._v("If you would like to include th2 read components into your configuration, you also have to set up a dedicated PersistentVolume for th2-read log directory.\nYou should add PersistentVolume mapped to /opt/components directory and then create PersistentVolumeClaim once a schema namespace installed. PV and PVC examples can be found here "),a("a",{attrs:{href:"https://github.com/th2-net/th2-infra/tree/master/example-values/persistence/",target:"_blank",rel:"nofollow noopener noreferrer"}},[e._v("persistence/")])]),a("div",{staticClass:"remark-highlight"},[a("pre",{staticClass:"language-shell"},[a("code",{staticClass:"language-shell"},[e._v("$ "),a("span",{staticClass:"token function"},[e._v("mkdir")]),e._v(" /opt/components\n")])]),a("copy-code-btn")],1),a("ul",[a("li",[e._v("set node name in "),a("code",{pre:!0},[e._v("persistence/pv.yaml")])]),a("li",[e._v("create PV:")])]),a("div",{staticClass:"remark-highlight"},[a("pre",{staticClass:"language-shell"},[a("code",{staticClass:"language-shell"},[e._v("$ kubectl apply -f ./persistence/pv.yaml\n")])]),a("copy-code-btn")],1),a("ul",[a("li",[e._v("create PVC:")])]),a("div",{staticClass:"remark-highlight"},[a("pre",{staticClass:"language-shell"},[a("code",{staticClass:"language-shell"},[e._v("$ kubectl apply -f ./persistence/pvc.yaml\n")])]),a("copy-code-btn")],1),a("p",[e._v("Details for th2-read-log "),a("a",{attrs:{href:"https://github.com/th2-net/th2-read-log#configuration",target:"_blank",rel:"nofollow noopener noreferrer"}},[e._v("README.md")])]),a("h2",{attrs:{id:"monitoring-deployment"}},[a("a",{attrs:{href:"#monitoring-deployment","aria-hidden":"true"}},[e._v("#")]),e._v("Monitoring deployment")]),a("p",[a("em",[e._v("Note: It's an optional step, but it gets slightly simpler checking the result of installation. In all installation commands we explicitly define namespaces to avoid possible mistakes.")])]),a("ul",[a("li",[e._v("Define Grafana host names (the name must be resolved from QA boxes) in the "),a("a",{attrs:{href:"https://github.com/th2-net/th2-infra/blob/master/example-values/prometheus-operator.values.yaml",target:"_blank",rel:"nofollow noopener noreferrer"}},[e._v("prometheus-operator.values.yaml")]),e._v(" file")])]),a("div",{staticClass:"remark-highlight"},[a("pre",{staticClass:"language-shell"},[a("code",{staticClass:"language-shell"},[e._v("grafana:\n  ingress:\n    hosts:\n      - "),a("span",{staticClass:"token operator"},[e._v("<")]),e._v("th2_host_name"),a("span",{staticClass:"token operator"},[e._v(">")]),e._v("\n")])]),a("copy-code-btn")],1),a("ul",[a("li",[e._v("Deploy components")])]),a("div",{staticClass:"remark-highlight"},[a("pre",{staticClass:"language-shell"},[a("code",{staticClass:"language-shell"},[e._v("$ helm repo "),a("span",{staticClass:"token function"},[e._v("add")]),e._v(" grafana https://grafana.github.io/helm-charts\n$ helm repo "),a("span",{staticClass:"token function"},[e._v("add")]),e._v(" prometheus-community https://prometheus-community.github.io/helm-charts\n$ helm "),a("span",{staticClass:"token function"},[e._v("install")]),e._v(" --version"),a("span",{staticClass:"token operator"},[e._v("=")]),a("span",{staticClass:"token number"},[e._v("2.6")]),e._v(".5 loki -n monitoring grafana/loki-stack -f ./loki.values.yaml\n$ helm "),a("span",{staticClass:"token function"},[e._v("install")]),e._v(" --version"),a("span",{staticClass:"token operator"},[e._v("=")]),a("span",{staticClass:"token number"},[e._v("21.0")]),e._v(".5 prometheus -n monitoring prometheus-community/kube-prometheus-stack -f ./prometheus-operator.values.yaml\n")])]),a("copy-code-btn")],1),a("ul",[a("li",[e._v("Check result:")])]),a("div",{staticClass:"remark-highlight"},[a("pre",{staticClass:"language-shell"},[a("code",{staticClass:"language-shell"},[e._v("$ kubectl get pods\nNAME                                                     READY   STATUS    RESTARTS   AGE\n"),a("span",{staticClass:"token punctuation"},[e._v("..")]),a("span",{staticClass:"token punctuation"},[e._v("..")]),a("span",{staticClass:"token punctuation"},[e._v("..")]),a("span",{staticClass:"token punctuation"},[e._v("..")]),e._v("\nalertmanager-prometheus-prometheus-oper-alertmanager-0   "),a("span",{staticClass:"token number"},[e._v("2")]),e._v("/2     Running   "),a("span",{staticClass:"token number"},[e._v("0")]),e._v("          75s\nloki-0                                                   "),a("span",{staticClass:"token number"},[e._v("1")]),e._v("/1     Running   "),a("span",{staticClass:"token number"},[e._v("0")]),e._v("          4m47s\nloki-promtail-wqfml                                      "),a("span",{staticClass:"token number"},[e._v("1")]),e._v("/1     Running   "),a("span",{staticClass:"token number"},[e._v("0")]),e._v("          4m47s\nprometheus-grafana-68f8dd6d57-2gtns                      "),a("span",{staticClass:"token number"},[e._v("2")]),e._v("/2     Running   "),a("span",{staticClass:"token number"},[e._v("0")]),e._v("          82s\nprometheus-kube-state-metrics-75d4cc9dbd-psb88           "),a("span",{staticClass:"token number"},[e._v("1")]),e._v("/1     Running   "),a("span",{staticClass:"token number"},[e._v("0")]),e._v("          82s\nprometheus-prometheus-node-exporter-gfzp6                "),a("span",{staticClass:"token number"},[e._v("1")]),e._v("/1     Running   "),a("span",{staticClass:"token number"},[e._v("0")]),e._v("          82s\nprometheus-prometheus-oper-operator-df668d457-snxks      "),a("span",{staticClass:"token number"},[e._v("1")]),e._v("/1     Running   "),a("span",{staticClass:"token number"},[e._v("0")]),e._v("          82s\nprometheus-prometheus-prometheus-oper-prometheus-0       "),a("span",{staticClass:"token number"},[e._v("3")]),e._v("/3     Running   "),a("span",{staticClass:"token number"},[e._v("1")]),e._v("          65s        \n"),a("span",{staticClass:"token punctuation"},[e._v("..")]),a("span",{staticClass:"token punctuation"},[e._v("..")]),a("span",{staticClass:"token punctuation"},[e._v("..")]),a("span",{staticClass:"token punctuation"},[e._v("..")]),e._v("\n")])]),a("copy-code-btn")],1),a("ul",[a("li",[e._v("Check access to Grafana "),a("em",[e._v("(default user/password: "),a("code",{pre:!0},[e._v("admin/prom-operator")]),e._v(". Must be changed)")]),e._v(": "),a("br"),a("a",{attrs:{href:"http://your-host:30000/grafana/login",target:"_blank",rel:"nofollow noopener noreferrer"}},[e._v("http://your-host:30000/grafana/login")])])]),a("h2",{attrs:{id:"cluster-configuration"}},[a("a",{attrs:{href:"#cluster-configuration","aria-hidden":"true"}},[e._v("#")]),e._v("Cluster configuration")]),a("p",[e._v("Once all of the required software is installed on your test-box and operator-box and th2-infra repositories are ready you can start configuring the cluster.")]),a("h3",{attrs:{id:"access-for-infra-mgr-th2-schema-git-repository"}},[a("a",{attrs:{href:"#access-for-infra-mgr-th2-schema-git-repository","aria-hidden":"true"}},[e._v("#")]),e._v("Access for infra-mgr th2 schema git repository:")]),a("p",[a("code",{pre:!0},[e._v("ssh")]),e._v(" or "),a("code",{pre:!0},[e._v("https")]),e._v(" access with write permissions is required by "),a("strong",[e._v("th2-infra-mgr")]),e._v(" component")]),a("h4",{attrs:{id:"set-up-ssh-access"}},[a("a",{attrs:{href:"#set-up-ssh-access","aria-hidden":"true"}},[e._v("#")]),e._v("Set up "),a("strong",[e._v("ssh")]),e._v(" access")]),a("ul",[a("li",[e._v("Generate keys without passphrase  ")])]),a("div",{staticClass:"remark-highlight"},[a("pre",{staticClass:"language-shell"},[a("code",{staticClass:"language-shell"},[e._v("$ ssh-keygen -t rsa -m pem -f ./infra-mgr-rsa.key\n")])]),a("copy-code-btn")],1),a("ul",[a("li",[e._v("Get key in base64 format and put in infraMgr.git.privateKey")])]),a("div",{staticClass:"remark-highlight"},[a("pre",{staticClass:"language-shell"},[a("code",{staticClass:"language-shell"},[e._v("$ base64 -w "),a("span",{staticClass:"token number"},[e._v("0")]),e._v(" ./infra-mgr-rsa.key\n")])]),a("copy-code-btn")],1),a("ul",[a("li",[a("a",{attrs:{href:"https://docs.github.com/en/developers/overview/managing-deploy-keys#deploy-keys",target:"_blank",rel:"nofollow noopener noreferrer"}},[e._v("Add a new deploy key to your schema repository on GitHub ")])])]),a("h4",{attrs:{id:"set-up-https-access"}},[a("a",{attrs:{href:"#set-up-https-access","aria-hidden":"true"}},[e._v("#")]),e._v("Set up "),a("strong",[e._v("https")]),e._v(" access")]),a("ul",[a("li",[a("a",{attrs:{href:"https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/creating-a-personal-access-token",target:"_blank",rel:"nofollow noopener noreferrer"}},[e._v("Generate access token for schema repository with read and write permissions")])]),a("li",[e._v("Set up values in secrets.yaml file (described below)")])]),a("h3",{attrs:{id:"set-the-repository-with-schema-configuration"}},[a("a",{attrs:{href:"#set-the-repository-with-schema-configuration","aria-hidden":"true"}},[e._v("#")]),e._v("Set the repository with schema configuration")]),a("p",[e._v("set "),a("code",{pre:!0},[e._v("infraMgr.git.repository")]),e._v(" value in the "),a("a",{attrs:{href:"https://github.com/th2-net/th2-infra/blob/master/example-values/service.values.yaml",target:"_blank",rel:"nofollow noopener noreferrer"}},[e._v("service.values.yaml")]),e._v(" file to link of your schema repository, "),a("code",{pre:!0},[e._v("ssh")]),e._v(" or "),a("code",{pre:!0},[e._v("https")]),e._v(":")]),a("ul",[a("li",[a("strong",[e._v("ssh")])])]),a("div",{staticClass:"remark-highlight"},[a("pre",{staticClass:"language-shell"},[a("code",{staticClass:"language-shell"},[e._v("infraMgr:\n  git:\n    repository: git@github.com:th2-net/th2-infra-demo-configuration.git\n")])]),a("copy-code-btn")],1),a("ul",[a("li",[a("strong",[e._v("https")])])]),a("div",{staticClass:"remark-highlight"},[a("pre",{staticClass:"language-shell"},[a("code",{staticClass:"language-shell"},[e._v("infraMgr:\n  git:\n    repository: https://github.com/th2-net/th2-infra-schema-demo.git\n")])]),a("copy-code-btn")],1),a("h3",{attrs:{id:"define-cassandra-host-name"}},[a("a",{attrs:{href:"#define-cassandra-host-name","aria-hidden":"true"}},[e._v("#")]),e._v("Define cassandra host name")]),a("ul",[a("li",[e._v("set "),a("code",{pre:!0},[e._v("cassandra.host")]),e._v(" value for cassandra in the "),a("a",{attrs:{href:"https://github.com/th2-net/th2-infra/blob/master/./example-values/service.values.yaml",target:"_blank",rel:"nofollow noopener noreferrer"}},[e._v("service.values.yaml")]),e._v(" file.")])]),a("div",{staticClass:"remark-highlight"},[a("pre",{staticClass:"language-shell"},[a("code",{staticClass:"language-shell"},[e._v("cassandra:\n  internal: "),a("span",{staticClass:"token boolean"},[e._v("false")]),e._v("\n  host: "),a("span",{staticClass:"token operator"},[e._v("<")]),e._v("cassandra-host"),a("span",{staticClass:"token operator"},[e._v(">")]),e._v("\n")])]),a("copy-code-btn")],1),a("h3",{attrs:{id:"define-th2-ingress-parameters"}},[a("a",{attrs:{href:"#define-th2-ingress-parameters","aria-hidden":"true"}},[e._v("#")]),e._v("Define th2 ingress parameters")]),a("ul",[a("li",[e._v("Add "),a("code",{pre:!0},[e._v("ingress.hostname")]),e._v(" value if required into "),a("a",{attrs:{href:"https://github.com/th2-net/th2-infra/blob/master/example-values/service.values.yaml",target:"_blank",rel:"nofollow noopener noreferrer"}},[e._v("service.values.yaml")]),e._v(" file otherwise th2 http services will be available on node IP address")])]),a("div",{staticClass:"remark-highlight"},[a("pre",{staticClass:"language-shell"},[a("code",{staticClass:"language-shell"},[e._v("ingress:\n  host: example.com\n"),a("span",{staticClass:"token punctuation"},[e._v("..")]),e._v(".\nkubernetes-dashboard:\n  ingress:\n    hosts:\n    - example.com\n"),a("span",{staticClass:"token punctuation"},[e._v("..")]),e._v(".\nrabbitmq:\n  ingress:\n    hostname: example.com\n")])]),a("copy-code-btn")],1),a("h3",{attrs:{id:"create-secret-with-th2-credentials"}},[a("a",{attrs:{href:"#create-secret-with-th2-credentials","aria-hidden":"true"}},[e._v("#")]),e._v("Create secret with th2 credentials")]),a("p",[e._v("Create secrets.yaml in "),a("code",{pre:!0},[e._v("./")]),e._v(" folder ("),a("em",[e._v("do not commit into git")]),e._v("). Example:")]),a("div",{staticClass:"remark-highlight"},[a("pre",{staticClass:"language-shell"},[a("code",{staticClass:"language-shell"},[a("span",{staticClass:"token comment"},[e._v("# reguired only for images from a private registry, will be attached as the first PullSecret to deployments")]),e._v("\n"),a("span",{staticClass:"token comment"},[e._v("#registries:")]),e._v("\n"),a("span",{staticClass:"token comment"},[e._v("#  registry1.name.com:8080:")]),e._v("\n"),a("span",{staticClass:"token comment"},[e._v("#    username: <username>")]),e._v("\n"),a("span",{staticClass:"token comment"},[e._v("#    password: <password>")]),e._v("\n"),a("span",{staticClass:"token comment"},[e._v("#  registry2.name.com:8080:")]),e._v("\n"),a("span",{staticClass:"token comment"},[e._v("#    username: <username>")]),e._v("\n"),a("span",{staticClass:"token comment"},[e._v("#    password: <password>")]),e._v("\n\ncassandra:\n"),a("span",{staticClass:"token comment"},[e._v("# set credentials for existing Cassandra cluster")]),e._v("\n  dbUser:\n    user: "),a("span",{staticClass:"token operator"},[e._v("<")]),e._v("user-name"),a("span",{staticClass:"token operator"},[e._v(">")]),e._v("\n    password: "),a("span",{staticClass:"token operator"},[e._v("<")]),e._v("password"),a("span",{staticClass:"token operator"},[e._v(">")]),e._v("\n\nrabbitmq:\n"),a("span",{staticClass:"token comment"},[e._v("# set admin user credentials, it will be created during deployment")]),e._v("\n  auth:\n    username: th2\n    password: rab-pass\n    "),a("span",{staticClass:"token comment"},[e._v("# must be random string")]),e._v("\n    erlangCookie: cookie\n\n"),a("span",{staticClass:"token comment"},[e._v("# required if http(s) access to gitlab/github repositories is used")]),e._v("\n"),a("span",{staticClass:"token comment"},[e._v("#infraMgr:")]),e._v("\n"),a("span",{staticClass:"token comment"},[e._v("#  git:")]),e._v("\n"),a("span",{staticClass:"token comment"},[e._v("#    privateKey: <private key in base64>")]),e._v("\n"),a("span",{staticClass:"token comment"},[e._v("#    httpAuthUsername: username")]),e._v("\n"),a("span",{staticClass:"token comment"},[e._v("#    # authentication username")]),e._v("\n"),a("span",{staticClass:"token comment"},[e._v('#    # when using token auth for GitLab it should be equal to "oauth2"')]),e._v("\n"),a("span",{staticClass:"token comment"},[e._v("#    # when using token auth for GitHub it should be equal to token itself")]),e._v("\n"),a("span",{staticClass:"token comment"},[e._v("#    httpAuthPassword: ")]),e._v("\n"),a("span",{staticClass:"token comment"},[e._v("#    # authentication password")]),e._v("\n"),a("span",{staticClass:"token comment"},[e._v("#    # when using token auth for GitLab it should be equal to token itself")]),e._v("\n"),a("span",{staticClass:"token comment"},[e._v("#    # when using token auth for GitHub it should be equal to empty string")]),e._v("\n")])]),a("copy-code-btn")],1),a("h3",{attrs:{id:"infra-git-deployment"}},[a("a",{attrs:{href:"#infra-git-deployment","aria-hidden":"true"}},[e._v("#")]),e._v("infra-git deployment")]),a("p",[e._v("If you have any restrictions to get access to any external repositories from the k8s cluster git service can be deployed according to the following instruction:")]),a("ul",[a("li",[e._v('Create PersistentVolume "repos-volume", example is presented in the ./example-values/persistence/pv.yaml or your own PVC')]),a("li",[e._v('Create configmap "keys-repo" from public part of key from point "Access for infra-mgr th2 schema git repository":')])]),a("div",{staticClass:"remark-highlight"},[a("pre",{staticClass:"language-shell"},[a("code",{staticClass:"language-shell"},[e._v("$ kubectl -n "),a("span",{staticClass:"token function"},[e._v("service")]),e._v(" create configmap keys-repo --from-file"),a("span",{staticClass:"token operator"},[e._v("=")]),e._v("authorized_keys"),a("span",{staticClass:"token operator"},[e._v("=")]),e._v("./infra-mgr-rsa.pub\n")])]),a("copy-code-btn")],1),a("ul",[a("li",[e._v("Define configs for infra-git in services.values.yaml")]),a("li",[e._v("set "),a("code",{pre:!0},[e._v("infraMgr.git.repository")]),e._v(" value in the service.values.yaml file to "),a("strong",[e._v("ssh")]),e._v(" link of your repository, e.g:")])]),a("div",{staticClass:"remark-highlight"},[a("pre",{staticClass:"language-shell"},[a("code",{staticClass:"language-shell"},[e._v("infraMgr:\n  git:\n    repository: ssh://git@infra-git/home/git/repo/schema.git\n")])]),a("copy-code-btn")],1),a("ul",[a("li",[e._v("after installation you should create folder with the same path and the name "),a("code",{pre:!0},[e._v("schema.git")]),e._v(" that you define in previous step inside infra-git pod and initialise it as a git repo.")])]),a("div",{staticClass:"remark-highlight"},[a("pre",{staticClass:"language-shell"},[a("code",{staticClass:"language-shell"},[e._v("$ "),a("span",{staticClass:"token function"},[e._v("su")]),e._v(" "),a("span",{staticClass:"token function"},[e._v("git")]),e._v("\n$ "),a("span",{staticClass:"token function"},[e._v("mkdir")]),e._v(" /home/git/repo/schema.git\n$ "),a("span",{staticClass:"token builtin class-name"},[e._v("cd")]),e._v(" /home/git/repo/schema.git\n$ "),a("span",{staticClass:"token function"},[e._v("git")]),e._v(" init --bare\n")])]),a("copy-code-btn")],1),a("ul",[a("li",[e._v("to connect to your created repository add this host to your ~/.ssh/config")])]),a("div",{staticClass:"remark-highlight"},[a("pre",{staticClass:"language-shell"},[a("code",{staticClass:"language-shell"},[e._v("Host "),a("span",{staticClass:"token operator"},[e._v("<")]),e._v("node-address"),a("span",{staticClass:"token operator"},[e._v(">")]),e._v("\n    User "),a("span",{staticClass:"token function"},[e._v("git")]),e._v("\n    Port "),a("span",{staticClass:"token number"},[e._v("32600")]),e._v("\n    IdentityFile ~/path_to_private_key/infra-mgr-rsa.key\n")])]),a("copy-code-btn")],1),a("ul",[a("li",[e._v("clone your infra-git repo using ")])]),a("div",{staticClass:"remark-highlight"},[a("pre",{staticClass:"language-shell"},[a("code",{staticClass:"language-shell"},[e._v("$ "),a("span",{staticClass:"token function"},[e._v("git")]),e._v(" clone git@"),a("span",{staticClass:"token operator"},[e._v("<")]),e._v("node-address"),a("span",{staticClass:"token operator"},[e._v(">")]),e._v(":/home/git/repo/schema.git\n")])]),a("copy-code-btn")],1),a("h2",{attrs:{id:"th2-deployment"}},[a("a",{attrs:{href:"#th2-deployment","aria-hidden":"true"}},[e._v("#")]),e._v("th2 deployment")]),a("h3",{attrs:{id:"install-nginx-ingress-controller"}},[a("a",{attrs:{href:"#install-nginx-ingress-controller","aria-hidden":"true"}},[e._v("#")]),e._v("Install NGINX Ingress Controller")]),a("div",{staticClass:"remark-highlight"},[a("pre",{staticClass:"language-shell"},[a("code",{staticClass:"language-shell"},[e._v("$ helm repo "),a("span",{staticClass:"token function"},[e._v("add")]),e._v(" ingress-nginx https://kubernetes.github.io/ingress-nginx\n$ helm "),a("span",{staticClass:"token function"},[e._v("install")]),e._v(" -n "),a("span",{staticClass:"token function"},[e._v("service")]),e._v(" --version"),a("span",{staticClass:"token operator"},[e._v("=")]),a("span",{staticClass:"token number"},[e._v("4.1")]),e._v(".2 ingress ingress-nginx/ingress-nginx -f ./ingress.values.yaml\n")])]),a("copy-code-btn")],1),a("p",[e._v("Check:")]),a("div",{staticClass:"remark-highlight"},[a("pre",{staticClass:"language-shell"},[a("code",{staticClass:"language-shell"},[e._v("$ kubectl get pods\nNAME                                                READY   STATUS    RESTARTS   AGE\n"),a("span",{staticClass:"token punctuation"},[e._v("..")]),a("span",{staticClass:"token punctuation"},[e._v("..")]),a("span",{staticClass:"token punctuation"},[e._v("..")]),a("span",{staticClass:"token punctuation"},[e._v("..")]),e._v("\ningress-ingress-nginx-controller-7979dcdd85-mw42w   "),a("span",{staticClass:"token number"},[e._v("1")]),e._v("/1     Running   "),a("span",{staticClass:"token number"},[e._v("0")]),e._v("          30s\n"),a("span",{staticClass:"token punctuation"},[e._v("..")]),a("span",{staticClass:"token punctuation"},[e._v("..")]),a("span",{staticClass:"token punctuation"},[e._v("..")]),a("span",{staticClass:"token punctuation"},[e._v("..")]),e._v("\n")])]),a("copy-code-btn")],1),a("h3",{attrs:{id:"install-th2-infra-components-in-the-service-namespace"}},[a("a",{attrs:{href:"#install-th2-infra-components-in-the-service-namespace","aria-hidden":"true"}},[e._v("#")]),e._v("Install th2-infra components in the service namespace")]),a("div",{staticClass:"remark-highlight"},[a("pre",{staticClass:"language-shell"},[a("code",{staticClass:"language-shell"},[e._v("$ helm repo "),a("span",{staticClass:"token function"},[e._v("add")]),e._v(" th2 https://th2-net.github.io\n$ helm "),a("span",{staticClass:"token function"},[e._v("install")]),e._v(" -n "),a("span",{staticClass:"token function"},[e._v("service")]),e._v(" --version"),a("span",{staticClass:"token operator"},[e._v("=")]),a("span",{staticClass:"token operator"},[e._v("<")]),e._v("version"),a("span",{staticClass:"token operator"},[e._v(">")]),e._v(" th2-infra th2/th2 -f ./service.values.yaml -f ./secrets.yaml\n")])]),a("copy-code-btn")],1),a("p",[a("em",[e._v("Note")]),e._v(": replace <version> with th2-infra release version you need, please follow to "),a("a",{attrs:{href:"https://github.com/th2-net/th2-infra/releases",target:"_blank",rel:"nofollow noopener noreferrer"}},[e._v("https://github.com/th2-net/th2-infra/releases")])]),a("p",[e._v("Wait for all pods in service namespace are up and running, once completed proceed with "),a("a",{attrs:{href:"https://github.com/th2-net/th2-infra-schema-demo/blob/master/README.md",target:"_blank",rel:"nofollow noopener noreferrer"}},[e._v("schema configuration")]),e._v(" to deploy th2 namespaces.")]),a("h3",{attrs:{id:"upgrade-th2-infra"}},[a("a",{attrs:{href:"#upgrade-th2-infra","aria-hidden":"true"}},[e._v("#")]),e._v("Upgrade th2-infra")]),a("ul",[a("li",[e._v("Purge th2 namespaces and uninstall th2-infra Helm release")])]),a("div",{staticClass:"remark-highlight"},[a("pre",{staticClass:"language-shell"},[a("code",{staticClass:"language-shell"},[e._v("$ helm -n "),a("span",{staticClass:"token function"},[e._v("service")]),e._v(" uninstall th2-infra\n")])]),a("copy-code-btn")],1),a("p",[e._v("remove th2 namespaces")]),a("div",{staticClass:"remark-highlight"},[a("pre",{staticClass:"language-shell"},[a("code",{staticClass:"language-shell"},[e._v("$ kubectel delete "),a("span",{staticClass:"token operator"},[e._v("<")]),e._v("namespace-"),a("span",{staticClass:"token operator"},[a("span",{staticClass:"token file-descriptor important"},[e._v("1")]),e._v(">")]),e._v(" "),a("span",{staticClass:"token operator"},[e._v("<")]),e._v("namespace-"),a("span",{staticClass:"token operator"},[a("span",{staticClass:"token file-descriptor important"},[e._v("2")]),e._v(">")]),e._v(" "),a("span",{staticClass:"token operator"},[e._v("<")]),e._v("namespace-"),a("span",{staticClass:"token punctuation"},[e._v("..")]),a("span",{staticClass:"token operator"},[e._v(">")]),e._v("\n")])]),a("copy-code-btn")],1),a("p",[e._v('or set "deny" in "infra-mgr-config.yml" file for all namespaces managed by th2-infra. Wait until it is removed, once completed uninstall th2-infra release')]),a("div",{staticClass:"remark-highlight"},[a("pre",{staticClass:"language-shell"},[a("code",{staticClass:"language-shell"},[e._v("$ helm -n "),a("span",{staticClass:"token function"},[e._v("service")]),e._v(" uninstall th2-infra\n")])]),a("copy-code-btn")],1),a("ul",[a("li",[e._v("Delete CRDs:")])]),a("div",{staticClass:"remark-highlight"},[a("pre",{staticClass:"language-shell"},[a("code",{staticClass:"language-shell"},[e._v("$ kubectl delete customresourcedefinitions th2boxes.th2.exactpro.com th2coreboxes.th2.exactpro.com th2dictionaries.th2.exactpro.com th2estores.th2.exactpro.com th2links.th2.exactpro.com th2mstores.th2.exactpro.com\n")])]),a("copy-code-btn")],1),a("p",[a("em",[e._v("Note")]),e._v(": the list can be various, see the full list in documentation or in k8s with the following command:")]),a("div",{staticClass:"remark-highlight"},[a("pre",{staticClass:"language-shell"},[a("code",{staticClass:"language-shell"},[e._v("$ kubectl get customresourcedefinitions "),a("span",{staticClass:"token operator"},[e._v("|")]),e._v(" "),a("span",{staticClass:"token function"},[e._v("grep")]),e._v(" "),a("span",{staticClass:"token string"},[e._v('"^th2"')]),e._v("\n")])]),a("copy-code-btn")],1),a("ul",[a("li",[e._v("Change service.values.yaml if it is required by th2-infra release notes")]),a("li",[e._v('Revise "Custom Resource" files for namespaces if it is required by th2-infra release notes')]),a("li",[e._v("Install th2-infra:")])]),a("div",{staticClass:"remark-highlight"},[a("pre",{staticClass:"language-shell"},[a("code",{staticClass:"language-shell"},[e._v("$ helm repo update\n$ helm "),a("span",{staticClass:"token function"},[e._v("install")]),e._v(" -n "),a("span",{staticClass:"token function"},[e._v("service")]),e._v(" --version"),a("span",{staticClass:"token operator"},[e._v("=")]),a("span",{staticClass:"token operator"},[e._v("<")]),e._v("new_version"),a("span",{staticClass:"token operator"},[e._v(">")]),e._v(" th2-infra th2/th2 -f ./service.values.yaml -f ./secrets.yaml\n")])]),a("copy-code-btn")],1),a("p",[a("em",[e._v("Note")]),e._v(": replace <new_version> with th2-infra release version you need, please follow to "),a("a",{attrs:{href:"https://github.com/th2-net/th2-infra/release",target:"_blank",rel:"nofollow noopener noreferrer"}},[e._v("https://github.com/th2-net/th2-infra/release")])]),a("h3",{attrs:{id:"re-adding-persistence-for-components-in-th2-namespaces"}},[a("a",{attrs:{href:"#re-adding-persistence-for-components-in-th2-namespaces","aria-hidden":"true"}},[e._v("#")]),e._v("Re-adding persistence for components in th2 namespaces")]),a("p",[e._v("PersistentVolumeClaim is namespace scoped resource, so after namespace re-creation PVCs should be added for components require persistence.")]),a("ul",[a("li",[e._v("Check the state of PV in a cluster:")])]),a("div",{staticClass:"remark-highlight"},[a("pre",{staticClass:"language-shell"},[a("code",{staticClass:"language-shell"},[e._v("$ kubectl get "),a("span",{staticClass:"token function"},[e._v("pv")]),e._v("\n")])]),a("copy-code-btn")],1),a("ul",[a("li",[e._v("Reset PVs that are in Released status:")])]),a("div",{staticClass:"remark-highlight"},[a("pre",{staticClass:"language-shell"},[a("code",{staticClass:"language-shell"},[e._v("$ kubectl patch "),a("span",{staticClass:"token function"},[e._v("pv")]),e._v(" "),a("span",{staticClass:"token operator"},[e._v("<")]),e._v("pv-name"),a("span",{staticClass:"token operator"},[e._v(">")]),e._v(" -p "),a("span",{staticClass:"token string"},[e._v('\'{"spec":{"claimRef": null}}\'')]),e._v("\n")])]),a("copy-code-btn")],1),a("ul",[a("li",[e._v("Apply PVCs")])]),a("div",{staticClass:"remark-highlight"},[a("pre",{staticClass:"language-shell"},[a("code",{staticClass:"language-shell"},[e._v("$ kubectl -n "),a("span",{staticClass:"token operator"},[e._v("<")]),e._v("th2-namespace"),a("span",{staticClass:"token operator"},[e._v(">")]),e._v(" apply -f ./pvc.yaml\n")])]),a("copy-code-btn")],1),a("p",[a("em",[e._v("Note")]),e._v(": replace <th2-namespace> with th2 namespace you use")]),a("h2",{attrs:{id:"th2-in-openshift"}},[a("a",{attrs:{href:"#th2-in-openshift","aria-hidden":"true"}},[e._v("#")]),e._v("th2 in Openshift")]),a("p",[e._v("Steps with Ingress controller and Monitoring deployment should be skipped")]),a("p",[e._v("To support Openshift environment and Ingress controller, set the following value:")]),a("div",{staticClass:"remark-highlight"},[a("pre",{staticClass:"language-shell"},[a("code",{staticClass:"language-shell"},[a("span",{staticClass:"token comment"},[e._v("# -- Enable th2 for Openshift, impacts on Ingress.")]),e._v("\nopenshift:\n  enabled: "),a("span",{staticClass:"token boolean"},[e._v("true")]),e._v("\n")])]),a("copy-code-btn")],1),a("p",[e._v("Ingress related, e.g:")]),a("div",{staticClass:"remark-highlight"},[a("pre",{staticClass:"language-shell"},[a("code",{staticClass:"language-shell"},[e._v("ingress:\n  "),a("span",{staticClass:"token comment"},[e._v("# -- Ingress class")]),e._v("\n  ingressClass: "),a("span",{staticClass:"token string"},[e._v('""')]),e._v("\n  "),a("span",{staticClass:"token comment"},[e._v("# -- Hostname for th2 namespace services")]),e._v("\n  host: "),a("span",{staticClass:"token string"},[e._v('"th2.<domain>"')]),e._v("\n  "),a("span",{staticClass:"token comment"},[e._v("# -- Hostname for infra services. If not set, than host will be used")]),e._v("\n  infraHost: "),a("span",{staticClass:"token string"},[e._v('"th2-infra.<domain>"')]),e._v("\n  annotations:\n    default:\n      route.openshift.io/termination: "),a("span",{staticClass:"token string"},[e._v('"edge"')]),e._v("\n      haproxy.router.openshift.io/rewrite-target: /\n")])]),a("copy-code-btn")],1),a("p",[e._v("and similar Ingress options for dependency charts.")]),a("p",[e._v("Expose services as LoadBalancer if available.")]),a("h2",{attrs:{id:"th2-infra-links"}},[a("a",{attrs:{href:"#th2-infra-links","aria-hidden":"true"}},[e._v("#")]),e._v("th2 infra links:")]),a("ul",[a("li",[e._v("Kubernetes dashboard "),a("a",{attrs:{href:"http://your-host:30000/dashboard/",target:"_blank",rel:"nofollow noopener noreferrer"}},[e._v("http://your-host:30000/dashboard/")])]),a("li",[e._v("Grafana "),a("a",{attrs:{href:"http://your-host:30000/grafana/",target:"_blank",rel:"nofollow noopener noreferrer"}},[e._v("http://your-host:30000/grafana/")])]),a("li",[e._v("th2-infra-editor "),a("a",{attrs:{href:"http://your-host:30000/editor/",target:"_blank",rel:"nofollow noopener noreferrer"}},[e._v("http://your-host:30000/editor/")])]),a("li",[e._v("RabbitMQ "),a("a",{attrs:{href:"http://your-host:30000/rabbitmq/",target:"_blank",rel:"nofollow noopener noreferrer"}},[e._v("http://your-host:30000/rabbitmq/")])]),a("li",[e._v("th2-reports "),a("a",{attrs:{href:"http://your-host:30000/your-namespace/",target:"_blank",rel:"nofollow noopener noreferrer"}},[e._v("http://your-host:30000/your-namespace/")])])]),a("h2",{attrs:{id:"migration-to-v181-th2-infra-chart"}},[a("a",{attrs:{href:"#migration-to-v181-th2-infra-chart","aria-hidden":"true"}},[e._v("#")]),e._v("Migration to v1.8.1 th2-infra chart")]),a("p",[e._v("Follow to migration guide with link above "),a("a",{attrs:{href:"https://github.com/th2-net/th2-infra/blob/master/docs/MIGRATION.md",target:"_blank",rel:"nofollow noopener noreferrer"}},[e._v("MIGRATION")])])])}),[],!1,null,null,null);"function"==typeof l&&l(u),"function"==typeof v&&v(u);t.default=u.exports}}]);