{"hash":"42e3905f95464c88d1c3007f0efced0d0c4402cb","data":{"doc":{"title":"th2-estore","inner_title":"","description":"th2-estore\n\nestore is one of the core components in the th2 environment. \nIt is responsible for storing events into Cradle. \nSending events to estore from other components is possible via special methods from the th2-common library.","content":"\n# th2-estore\n\n**estore** is one of the core components in the th2 environment. \nIt is responsible for storing events into <term term=\"Cradle\">Cradle</term>. \nSending events to **estore** from other components is possible via special methods from the <term term=\"th2-common\">th2-common</term> library.\n\n<!--more-->\n\n## Functionality\n\n### Events\n\nEvent is a fundamental unit of data stored and processed by th2. \nTest execution data as well as information related to the work of all th2 components are presented via events hierarchy. \nEvery event in th2 consists of important parts:\n\n- `id` - unique identifier (in UUID format) within the th2.\n- `parentId` - optional link to a parent event.\n- `description` - set of fields for short descriptions.\n- `body` - useful data in JSON format.\n- `attachedMessageIDs` - the list of message IDs that are linked to the event.\n\n### How to send events to estore\n\nYou can create `Event` object in th2 component with `th2-common-py` library.\n\nPut primary event data to variables. Maybe you will need it in the future.\n\n```py\nroot_event_id = EventID(id=str(uuid1()))\n\nstart_timestamp = Timestamp()\nstart_timestamp.FromDatetime(datetime.now())\n```\n\nCreate `Event` object.\n\n```py\nroot_event = Event(\n   id=root_event_id,\n   parent_id=None,\n   start_timestamp=start_timestamp,\n   # end_timestamp=\"\",\n   status=EventStatus.SUCCESS,\n   name=\"Test Event\",\n   body=b\"\"\n)\n```\n\nCreate `EventBatch` object and send it using event router.\n\n```py\nevent_batch = EventBatch(parent_event_id=None, events=[root_event])\nestore.send(event_batch)\n```\n\n## Configuration\n\n**estore** has its own <term term=\"Custom resource\">custom resource</term> definition called `Th2Estore`. \n\n<notice note>\n\nMake sure to indicate `Th2Estore` when specifying `kind` of the <term term=\"Custom resource\">custom resource</term> for `**estore**.\n\n</notice>\n\nInfra schema can contain only one **estore** box description. \nIt consists of a single required option - <term term=\"Docker Image\">docker_image</term>. \nConfiguration for <term term=\"pin\">pins</term> is specified in the `Th2Estore` <term term=\"Custom resource\">custom resource</term> definition. \nMore details on that are provided in the “Automatic pins configuration“ section.\n\nGeneral view of the component will look like this: \n\n```yaml\napiVersion: th2.exactpro.com/v1\nkind: Th2Estore\nmetadata:\n  name: estore\nspec:\n  image-name: ghcr.io/th2-net/th2-estore\n  image-version: <image version>\n  extended-settings:\n    service:\n      enabled: false\n    envVariables:\n      JAVA_TOOL_OPTIONS: \"-XX:+ExitOnOutOfMemoryError -Ddatastax-java-driver.advanced.connection.init-query-timeout=\\\"5000 milliseconds\\\"\"\n    resources:\n      limits:\n        memory: 500Mi\n        cpu: 200m\n      requests:\n        memory: 100Mi\n        cpu: 20m\n```\n\n### Automatic pins configuration\n\n<term term=\"th2-infra-operator\">th2-infra-operator</term> (component responsible for creating boxes) automatically adds special MQ <term term=\"pin\">pin</term> for receiving events to **estore** by any other component.\n\nAt the same time, any box with <term term=\"Custom resource\">CR</term> kind `Th2Box` will get special MQ <term term=\"pin\">pin</term> for sending events to the **estore**. These <term term=\"pin\">pins</term>  have attributes `event` and `publish`. \n","fileInfo":{"path":"versions/1-7/core/th2-estore.md"},"headings":[{"anchor":"#th2-estore","value":"th2-estore","depth":1},{"anchor":"#functionality","value":"Functionality","depth":2},{"anchor":"#events","value":"Events","depth":3},{"anchor":"#how-to-send-events-to-estore","value":"How to send events to estore","depth":3},{"anchor":"#configuration","value":"Configuration","depth":2},{"anchor":"#automatic-pins-configuration","value":"Automatic pins configuration","depth":3}],"read_before":[],"continue_learning":[],"terms":[{"id":"Cradle","title":"Cradle","content":"<p>Cradle is a datalake where th2 stores messages and events. It is based on Cassandra database and creates th2-specific data processing.</p>\n"},{"id":"th2-common","title":"th2-common","content":"<p>Basic library for th2 components. It provides API for interaction with other components, access to the <strong>th2-box</strong> configuration, and some functionality for automatic consuming of statistics. </p>\n"},{"id":"Custom resource","title":"Custom resource","content":"<p><em>Custom resources</em> are extensions of the Kubernetes API. It is not necessarily available in a default Kubernetes installation. It represents a customization of a particular Kubernetes installation. However, many core Kubernetes functions are now built using CRs, making Kubernetes more modular.</p>\n<p>You can find more information about <em>Custom resources</em> <a href=\"https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">here</a>.</p>\n"},{"id":"Docker Image","title":"Docker Image","content":"<p><em>Docker Image</em> is a stored instance of a Container that holds a set of software needed to run an application.</p>\n"},{"id":"pin","title":"pin","content":"<p>used by a box to connect th2 microservices between each other to send/receive messages, or to execute gRPC commands.</p>\n<p><a href=\"/1-7/infrastructure/th2-infra-schema/pins\">More</a></p>\n<!--TODO: make more flexible link (avoid mentioning version straight)-->\n"},{"id":"th2-infra-operator","title":"th2-infra-operator","content":"<p><em>th2-infra-operator</em> monitors the kubernetes cluster for changes and brings them to custom resources. </p>\n"}],"related":[{"name":"th2-net/cradleapi","icon":"mdi-github","href":"https://github.com/th2-net/cradleapi"}],"hide_releases":true,"_githubRepository":{"html_url":"https://github.com/th2-net/th2-estore","language":"Java","description":"","updated_at":"2022-08-30T08:32:46Z","owner":{"html_url":"https://github.com/th2-net","avatar_url":"https://avatars.githubusercontent.com/u/73948563?v=4","login":"th2-net"},"releases":[{"id":"82645766","name":"Release 4.1.1","tag_name":"4.1.1","body":"# What's new in release 4.1.1\r\n\r\n## New features\r\n\r\n### Manual acknowledgements\r\n\r\nMessage acknowledgements are sent after finishing persisting events. This prevents possibility to lose events in case of estore restart or failure.\r\nNote: if estore gives up persisting event due to exceeding retry limit, confirmation will still be sent\r\n\r\n### Bugfixes\r\n\r\nUsing Cradle 3.1.4 with a fix for degraded performance while persisting events\r\n\r\n### Other\r\n\r\nChanged default configuration to \r\n```json\r\n{\r\n    \"maxTaskCount\" : 256,\r\n    \"maxRetryCount\" : 1000000,\r\n    \"retryDelayBase\" : 5000\r\n}\r\n\r\n","published_at":"2022-11-10T08:52:14Z"},{"id":"77781840","name":"Release 4.1.0","tag_name":"v4.1.0","body":"# What's new in release 4.1.0\r\n\r\n## New features\r\n\r\n### Event processing parallelism control  \r\n\r\nIntroduced internal queue for storing events. Events from RabbitMQ are placed to this queue and stored to cradle. This queue is configuration limited by event count and event sizes at the same time. No new event can be added to this queue if queue limits are reached. This prevents estore from encountering OOM exceptions when many large events were stored in parallel, reaching estore heap limits.\r\n\r\n### Persistence retries\r\n\r\nestore can be configured to retry event persistence in case of failure.\r\n\r\n### Event batch durations\r\n\r\nUpdated cradle library allows to track event batch durations during persistence. This helps to retrieve event batches that contain events after specified timestamp\r\n\r\n### Prometheus metrics\r\n\r\nCollecting various performance metrics for exporting to Prometheus.\r\n\r\n\r\n### Other\r\n\r\n* Fixed Unicode string serialization / deserialization bug\r\n* Fixed bug that in highly concurrent scenarios caused estore to freeze.\r\n* Common library has been updated to `3.39.3`\r\n* Cradle library has been updated to `3.1.3`\r\n\r\n","published_at":"2022-09-21T14:43:38Z"},{"id":"59474553","name":"Release 3.7.0","tag_name":"v3.7.0","body":"# What's new in release 3.7.0\r\n\r\n## New features\r\n\r\n### Use async methods for storing events to the Cradle\r\n\r\nEstore stores incoming events and information about attached messages asynchronously. It is mean estore gets events and stores them in a separate thread pool without blocking MQ listening tread in most cases. MQ listening thread is blocked when the thread pool for asynchronously storing is over and can't begin storing a new event.\r\nThis approach increases the throughput of the store. \r\n\r\n### Use timeout property from cradle_manager.json\r\n\r\nEstore uses some cradle's settings during work. \r\nTimeout defines maximum time limit in milliseconds for inserting new data into cradle. If set to 0 or ommited, the default value of 5000 is used.\r\nMax event batch size (`cradleMaxEventBatchSize`) is used by estore to implement rebatch feature.\r\n\r\n### Compressed metadata for events\r\n\r\nImplemented compression of batch events metadata after serialization. Metadata is decompressed before deserialization. If decompression fails due to data format, deserialization is made on given bytes, meaning that metadata was written by an old version of Cradle API.\r\n\r\n### Disable waiting for connection recovery when closing the SubscribeMonitor\r\n\r\nDependency to common library has been updated from `3.13.4` to `3.35.0` and cradle from `2.9.1` to `2.21.0`.\r\n\r\n### [store-common](https://github.com/th2-net/th2-store-common) is not needed anymore\r\n\r\nThere were some common methods for convert and store. Needed methods were moved to estore and redundant dependency was removed.\r\n\r\n### Other\r\n\r\n* Logging improvements\r\n\r\n**Full Changelog**: https://github.com/th2-net/th2-estore/compare/v2.3.0-beta...v3.7.0","published_at":"2022-04-14T09:34:27Z"},{"id":"34533499","name":"v2.3.0-beta","tag_name":"v2.3.0-beta","body":"Version for demo-configuration and demo-script.","published_at":"2020-11-28T15:59:23Z"}]}}},"context":{}}