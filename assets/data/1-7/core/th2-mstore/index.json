{"hash":"42e3905f95464c88d1c3007f0efced0d0c4402cb","data":{"doc":{"title":"th2-mstore","inner_title":"","description":"","content":"\n# th2-mstore\n\n## Overview\n\n**mstore** (th2 message store) is an important th2 component responsible for storing raw messages into <term term=\"Cradle\">Cradle</term>. \nThis component has a pin for listening to messages via MQ.\n\nAs a part of th2-core, **mstore** is responsible for saving and displaying data. \nThis component's logic is same for all the th2 environments. \nMessages are the data that is going in or out of th2. **mstore** saves content and metadata of those messages. \n\nWhen marking the pins during configurating other components, you can specify `store` attribute, which means that the messages from this pin will be stored via **mstore.** \n\n**mstore** interacts with Cradle and <term term=\"th2-common\">Common libraries</term>. \nUsing RabbitMQ **mstore** gets messages in batches, then it will try to pack batches more compactly, and finally write them to Cassandra using Cradle library. \nTake into account that the batches cannot be merged, if combined batch exceeds the size limitation configured in Cradle. \n\n## Family\n\n [th2-mstore](https://github.com/th2-net/th2-mstore) - component repository.\n\n## Functionality\n\nTo automatically connect the pin to **mstore** and to collect all the messages into <term term=\"Cradle\">Cradle</term>, you must mark a pin that produces raw messages in **conn**, **read** and **hand** boxes via the `store` attribute. \n\n**mstore** consumes raw messages. \nParsed messages are not accepted. \n\nRaw message is a base entity of th2. \nAll incoming / outgoing data is stored in this format. \nEvery raw message contains the following important parts:â€‹\n\n- session alias - unique identifier of business session;\n\n- direction - <term term=\"direction\">direction</term> of message stream;\n\n- sequence number - incremental identifier;\n\n- data - byte representation of a raw message.\n\nSession alias, direction and sequence number are a compound unique identifier of raw messages within th2.\n\n**mstore** uses two libraries - <term term=\"th2-common\">common</term> and Cradle.\n\nCommon library is responsible for collecting messages in **mstore** from all pins with `store` attribute.\n\n**mstore** uses Cradle library to write message batches in Cassandra.\n\n## Configuration:\n\n**infra-schema** can only contain one **mstore** box description. \nIt consists of one required option - a Docker image. \nPin configuration is generated and managed by **infra-operator**.\n\n### Configuration parameters\n\n- `drain-interval` - interval in milliseconds to drain all aggregated batches that are not stored yet. \n- The default value is `1000`.\n\n- `termination-timeout` - the timeout in milliseconds to await for the inner drain scheduler to finish all the tasks. \n- The default value is `5000`.\n\n```yaml\n{\n  \"drain-interval\": 1000,\n  \"termination-timeout\": 5000\n}\n```\n\n### Required pins and links\n\nA user does not need to set up a MQ pin in the **mstore** custom resource. The inbound **mstore** queues receive raw messages from all the boxes that have `mq` pins with the attribute `store`.  Examples of such boxes include **conn**, **hand**, and **read**.\n\n### Configuration example\n\nGeneral view of the component looks like this:\n\n```yaml\napiVersion: th2.exactpro.com/v1\nkind: Th2Mstore\nmetadata:\n  name: mstore\nspec:\n  image-name: ghcr.io/th2-net/th2-mstore\n  image-version: <image version>\n  custom-settings:\n    drain-interval: 1000\n    termination-timeout: 5000\n  extended-settings:\n    service:\n      enabled: false\n    envVariables:\n      JAVA_TOOL_OPTIONS: \"-XX:+ExitOnOutOfMemoryError -Ddatastax-java-driver.advanced.connection.init-query-timeout=\\\"5000 milliseconds\\\"\"\n    resources:\n      limits:\n        memory: 500Mi\n        cpu: 200m\n      requests:\n        memory: 100Mi\n        cpu: 20m\n```\n\n## Useful hints\n\n### Message batches\n\n**mstore** consumes `RawMessageBatch` objects. \nEvery batch must be built via the following rules:\n\n- all messages in one batch must have identical `session alias` and `direction`;\n\n- each batch must have messages in ascending order;\n\n- the first message in each batch for session alias + direction pair must have a sequence number that is greater than the last message from the previous batch for the same session alias + direction pair;\n\n- all the parts of one business message must be placed into one th2 batch and also several packages of business messages can be placed into one th2 batch.\n\n<notice note>\n\nSource business message can be split into several pieces when it is transferred via different protocols, for example, FIX message wrapped into HTTP package.\n\n</notice>\n\n<notice note>\n\n**mstore** 4.1+ works with grouped message batches that contains mixed sessions\n\n</notice>\n","fileInfo":{"path":"versions/1-7/core/th2-mstore.md"},"headings":[{"anchor":"#th2-mstore","value":"th2-mstore","depth":1},{"anchor":"#overview","value":"Overview","depth":2},{"anchor":"#family","value":"Family","depth":2},{"anchor":"#functionality","value":"Functionality","depth":2},{"anchor":"#configuration","value":"Configuration:","depth":2},{"anchor":"#configuration-parameters","value":"Configuration parameters","depth":3},{"anchor":"#required-pins-and-links","value":"Required pins and links","depth":3},{"anchor":"#configuration-example","value":"Configuration example","depth":3},{"anchor":"#useful-hints","value":"Useful hints","depth":2},{"anchor":"#message-batches","value":"Message batches","depth":3}],"read_before":[],"continue_learning":[],"terms":[{"id":"Cradle","title":"Cradle","content":"<p>Cradle is a datalake where th2 stores messages and events. It is based on Cassandra database and creates th2-specific data processing.</p>\n"},{"id":"th2-common","title":"th2-common","content":"<p>Basic library for th2 components. It provides API for interaction with other components, access to the <strong>th2-box</strong> configuration, and some functionality for automatic consuming of statistics. </p>\n"},{"id":"direction","title":"direction","content":"<p>Direction is th2 specific enumeration for designating direction of the message in the system:</p>\n<ul>\n<li><code>first</code> - messages are sent to System Under Test (request);</li>\n<li><code>second</code> - messages are recieved from System Under Test (response)</li>\n</ul>\n"}],"related":[{"name":"th2-net/cradleapi","icon":"mdi-github","href":"https://github.com/th2-net/cradleapi"}],"hide_releases":true,"_githubRepository":{"html_url":"https://github.com/th2-net/th2-mstore","language":"Java","description":"","updated_at":"2022-02-18T16:04:34Z","owner":{"html_url":"https://github.com/th2-net","avatar_url":"https://avatars.githubusercontent.com/u/73948563?v=4","login":"th2-net"},"releases":[{"id":"82653374","name":"Release 4.1.1","tag_name":"v.4.1.1","body":"# What's new in release 4.1.1\r\n\r\n+ Updated Cradle to 3.1.4. No changes regarding message persistence\r\n+ Changed default configuration to \r\n```json\r\n{\r\n    \"maxTaskCount\" : 256,\r\n    \"maxRetryCount\" : 1000000,\r\n    \"retryDelayBase\" : 5000,\r\n    \"drain-interval\" : 1000,\r\n    \"termination-timeout\" : 5000\r\n}\r\n\r\n","published_at":"2022-11-10T09:57:02Z"},{"id":"77809408","name":"Release 4.1.0","tag_name":"v4.1.0","body":"# What's new in release 4.1.0\r\n\r\n## New features\r\n\r\n### Message persistence parallelism control  \r\n\r\nIntroduced internal queue for storing message batches. Message batches from RabbitMQ are placed to this queue and stored to cradle. This queue is configuration limited by batch count and batch sizes at the same time. No new message batch can be added to this queue if queue limits are reached. This prevents mstore from encountering OOM exceptions when many large message batches were stored in parallel, reaching mstore heap limits.\r\n\r\n### Persistence retries\r\n\r\nmstore can be configured to retry message batch persistence in case of failure.\r\n\r\n\r\n### Message ordering verification improvement\r\n\r\nFor verification purposes when message with new session/direction is handled mstore tries to load its sequence and timestamp from cradle. This is helpful on cold start/restart to verify previous session continuity\r\n\r\n\r\n### Prometheus metrics\r\n\r\nCollecting various performance metrics for exporting to Prometheus.\r\n\r\n\r\n### Other\r\n\r\n* Fixed Unicode string serialization / deserialization bug\r\n* Common library has been updated to `3.39.3`\r\n* Cradle library has been updated to `3.1.3`\r\n\r\n","published_at":"2022-09-21T19:28:14Z"},{"id":"59475892","name":"Release 3.6.0","tag_name":"v3.6.0","body":"# What's new in release 3.6.0\r\n## New features\r\n\r\n### Added parameters drain-interval and termination-timeout to custom-settings section\r\n\r\nThe messages rebatching feature provides the ability to collect several small message batches into one according to the actual value of cradle property `cradleMaxMessageBatchSize`, the default value is 1MB.\r\nMstore doesn't split incoming batches into messages and can glue whole batches only. Drain interval - interval in milliseconds to drain all aggregated batches that are not stored yet, the default value is 1000. Termination timeout - timeout in milliseconds to wait for the inner drain scheduler to finish all the tasks, the default value is 5000.\r\n\r\n### Use timeout property from cradle_manager.json\r\n\r\nMstore uses some cradle settings during work. \r\nTimeout defines the maximum limit in milliseconds for inserting new data into the cradle. If set to 0 or omitted, the default value of 5000 is used.\r\nMax message batch size (`cradleMaxMessageBatchSize`) is used by mstore to implement rebatch feature.\r\n\r\n### Check message timestamp growing\r\n\r\nSequence and timestamp of incoming messages should always grow within the session alias and direction. Mstore already checks sequences growing, this version also checks timestamp growing. Mstore rejects the whole batch if the sequence number or timestamp of the first message is less or equal options than the last stored message.\r\n\r\n### [store-common](https://github.com/th2-net/th2-store-common) is not needed anymore\r\n\r\nThere were some common methods for converting and storing. Needed methods were moved to mstore and redundant dependency was removed.\r\n\r\n## Bug fixes\r\n\r\n### Disable waiting for connection recovery when closing the SubscribeMonitor\r\n\r\nDependency on the common library has been updated from `3.13.4` to `3.35.0` and cradle from `2.9.1` to `2.21.0`.\r\n\r\n### Other\r\n\r\n* Logging improvements\r\n\r\n**Full Changelog**: https://github.com/th2-net/th2-mstore/compare/v2.3.0-beta...v3.6.0","published_at":"2022-04-13T09:56:12Z"},{"id":"34533789","name":"v2.3.0-beta","tag_name":"v2.3.0-beta","body":"Version for demo-configuration and demo-script.","published_at":"2020-11-28T16:21:54Z"}]}}},"context":{}}