{"hash":"b71897897465a080a3971c51fcf02ffdbaffac8a","data":{"doc":{"title":"th2-infra-operator","inner_title":"","description":"","content":" \n\n# th2-infra-operator\n\n**infra-operator** (th2 infrastructure operator) is one of th2 infra components that works with the current state of th2 system. \nIt is installed along with the th2 framework infrastructure.\n\nBasically, **infra-operator** is an implementation of Kubernetes custom controller. \n\nIt monitors <term term=\"Custom resource\">custom resources</term> and ensures the synchronization between them and Helm releases in the Kubernetes cluster. \n\n\n## Functionality\n\n![img](./infra-operator.png)\n\nBeing the component that interacts with schema environment, **infra-operator** has the following objectives:\n\n- It monitors Kubernetes events related to the th2 <term term=\"Custom resource\">Custom resources</term> and generates or modifies the corresponding Helm Releases.\n- Based on the config map `rabbit-mq-app-config` which is deployed by **infra-mgr**, it creates Vhost in RabbitMQ for every schema namespace.\n- For each Vhost it creates a user in RabbitMQ and configures its permissions.\n- Based on the pins described in the custom resources it declares queues in RabbitMQ.\n- It binds the queues in RabbitMQ according to `Th2Link` resources.\n- Generates RabbitMQ configs for each resource that needs it.\n- Generates [gRPC](https://grpc.io/docs/) configs for each resource that needs it.\n\nMostly, **infra-operator** communicates with other infra components using Kubernetes as an intermediary. \nAll the interconnections are displayed on the diagram below.\n\n```plantuml\n@startuml\nleft to right direction\ntitle Role of th2-infra-operator\n\n[th2-infra-mgr <&person>] as mgr\n[th2-infra-operator] as operator\n[helm-operator] as hoperator\ncontrol Kubernetes\ncontrol RabbitMQ\n\nhoperator ~u~> Kubernetes: Listem for HelmRelease updates\noperator ~d~> Kubernetes : Listen for CR updates\n\nmgr --> Kubernetes : Manage th2 CR's\noperator --> RabbitMQ: Manage Queues\noperator --> RabbitMQ: Manage Vhosts\noperator --> Kubernetes: Manage HelmReleases\nhoperator --> Kubernetes: Update Kubernetes Native Resources\n@enduml\n```\n\n## Configuration\n\nSettings for **infra-operator** should be defined in the `infraOperator` section of the values file. \nThey will be applied during deployment of **infra** into the Kubernetes cluster. \n\nAll possible parameters with the descriptions are provided below:\n\n```yaml\n# infra-operator.yml\n# version 1.5.4\nnamespacePrefixes:\n  - namespace-\n  - prefixes-\n# these prefixes are used to filter namespaces that infra-operator will manage as a schema\nchart:\n# this section includes information about git or helm repository as a source of helm charts\n# you can specify either git or helm repository\n  # git repository parameters \n  git: git@some.server.com:some/repository\n  # git repository URL for helm charts used by Th2 Custom Resources\n  \n  ref: branch\n  # branch for helm charts\n  path: /path/to/charts\n  # repository path for charts\n  # helm repository parameters \n  repository: https://helm.server.com/some/repository\n  # helm repository URL for helm charts used by Th2 Custom Resources\n  name: components\n  # the name of the Helm chart without an alias\n  version: 3.2.0\n  # the targeted Helm chart version\nrabbitMQManagement:\n  host: host\n  # RabbitMQ host used for managing vHosts and users\n  \n  port: 8080\n  # RabbitMQ port\n  \n  username: username\n  # RabbitMQ management username\n  \n  password: password\n  # password for management user\n  \n  persistence: true\n  # determines if the RabbitMQ resources are persistent or not\n  \n  schemaPermissions:\n  # this section describes what permissions schema RabbitMQ user will have on its own resources\n  # see RabbitMQ documentation to find out how permissions are described\n    configure: pattern\n    # configuration permissions on resources\n    \n    read: pattern\n    # read permission on resources\n    \n    write: pattern\n    # write permission on resources\n    \nconfigMaps:\n# this section contains names of the ConfigMaps that are mounted in the boxes\n  rabbitMQ: rabbit-mq-config-map\n  # RabbitMQ server connectivity ConfigMap\nk8sUrl: kubernetes-address\n# address for kubernetes cluster. \n# this will be used as host in gRPC config for boxes that are running in node network or externally\nschemaSecrets:\n# this section contains secret names that are mounted in the boxes\n  rabbitMQ: rabbitmq\n  # secret name to connect to RabbitMQ server\n  cassandra: cassandra\n  # secret name to connect to cassandra database\n  \ningressHost: hostName\n# host name that will be used inside ingress rules\n```\n<spoiler title=\"Example of infra-operator config in service.values.yaml\">\n\n```yaml\n# service.values.yaml\n# ...\ninfraOperator:\n  image:\n    repository: ghcr.io/th2-net/th2-infra-operator\n    tag: 3.1.3\n  config:\n    namespacePrefixes: \n    - \"th2-\"\n```\n\n</spoiler>\n","fileInfo":{"path":"versions/1-7/infrastructure/infra-components/th2-infra-operator.md"},"headings":[{"anchor":"#th2-infra-operator","value":"th2-infra-operator","depth":1},{"anchor":"#functionality","value":"Functionality","depth":2},{"anchor":"#configuration","value":"Configuration","depth":2}],"read_before":[],"continue_learning":[],"terms":[{"id":"Custom resource","title":"Custom resource","content":"<p><em>Custom resources</em> are extensions of the Kubernetes API. It is not necessarily available in a default Kubernetes installation. It represents a customization of a particular Kubernetes installation. However, many core Kubernetes functions are now built using CRs, making Kubernetes more modular.</p>\n<p>You can find more information about <em>Custom resources</em> <a href=\"https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">here</a>.</p>\n"}],"related":[{"name":"th2-net/th2-infra","icon":"mdi-github","href":"https://github.com/th2-net/th2-infra"}],"hide_releases":null,"_githubRepository":{"html_url":"https://github.com/th2-net/th2-infra-operator","language":"Java","description":"","updated_at":"2021-12-10T14:51:16Z","owner":{"html_url":"https://github.com/th2-net","avatar_url":"https://avatars.githubusercontent.com/u/73948563?v=4","login":"th2-net"},"releases":[{"id":"35718675","name":"2.5.3","tag_name":"v2.5.3","body":"","published_at":"2020-12-25T13:33:29Z"}]}}},"context":{}}