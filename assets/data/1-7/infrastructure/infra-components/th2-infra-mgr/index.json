{"hash":"eb53be573f7641e44afd869d1bdfef529d471930","data":{"doc":{"title":"th2-infra-mgr","inner_title":"","description":"th2-infra-mgr\n\ninfra-mgr (th2 Infrastructure manager) is one of the th2 infra components. \nIt is installed alongside with the th2 framework infrastructure. \nBasically, infra-mgr is the of middle steps of interaction between the user and the Kubernetes cluster.","content":" \n\n# th2-infra-mgr\n\n**infra-mgr** (th2 Infrastructure manager) is one of the th2 [infra components](../.). \nIt is installed alongside with the th2 framework infrastructure. \nBasically, **infra-mgr** is the of middle steps of interaction between the user and the Kubernetes cluster.\n\n<!--more-->\n\n## Functionality\n\nThe th2 infra components control all infrastructure of th2 environments, from RabbitMQ exchanges to Kubernetes Pods.  \nAs for **infra-mgr**, it interacts with the **infra-schema**, **infra-editor**, and with Kubernetes cluster during process of changing th2 environment. \n\n```plantuml\n@startuml\nleft to right direction\n\n[th2-infra-editor <&pencil>] as editor\n[th2-infra-mgr <&person>] as mgr\nfolder schema [\nth2-infra-schema\n----\nboxes\ncore\ndictionaries\nlinks\ninfra-mgr-config.yml\n]\n\ncontrol Kubernetes\n\ndatabase Cassandra\n\neditor -r-> mgr : Edit schema\nmgr -u-> schema : Read\nmgr -u-> schema : Commit changes\n\nmgr --> Kubernetes : Manage namespaces\nmgr --> Kubernetes : Manage CR's\nmgr --> Cassandra: Create keyspaces*\n\nnote bottom of Cassandra\n  Keyspaces are created \n  by th2-infra-mgr in th2 1.7 and 1.8\nend note\n@enduml\n```\n\n**infra-mgr** receives necessary information about th2 environment from an **infra-schema** which describes a target state of cluster via a set of `.yaml` config files.\n\n**infra-schemas** in th2 can be vizualized in **infra-editor**, a web-based GUI for working with th2 states. \nWhen the user saves a new state in GUI, it changes a corresponding **infra-schema**. \nOnce updated, the **infra-schema** is applied by the same workflow as if it was changed manually.\n\n### Infra schema\n\n**infra-mgr** continiously monitors the **infra-schema** for updates. \nAlso, it can apply changes to the **infra-schema**, in some configuration cases.\n\n### Kubernetes cluster\n\nDepending on the configuration for th2 environment, **infra-mgr** can commit 3 types of changes in the Kubernetes cluster:\n\n1. Create namespaces for each th2 environment;\n2. Create basic ConfigMaps for th2 environments;\n3. Apply th2 Custom Resources which will be fetched by **infra-operator**;\n4. Delete existing custom resources.\n\n### Cassandra\n\nWhen a new th2 environment is created, **infra-mgr** generates a special config map for the Cassandra database. \nThis new config map is then used by **estore** or **mstore** to create a new keyspace in the Cassandra database for storing messages and events. \n\n<notice info>\n\n**infra-mgr** creates keyspaces directly on Cassandra only in th2 of versions 1.7 and 1.8.\n\n</notice>\n\n## Configuration\n\n**infra-mgr** can be configured on the th2 cluster level and th2 environment level.\n\n### th2 cluster\n\nSettings for **infra-mgr** should be defined in the section of special config map, which is applied during th2-infra installation to the Kubernetes cluster.\n\nExample provides default values for configuration.\n\n```yaml\n# service.values.yaml\n# ...\ninfraMgr:\n  image:\n    repository: ghcr.io/th2-net/th2-infra-mgr\n    tag: 1.1.1\n  git:\n    secretName: infra-mgr\n    privateKeyFileSecret: infra-mgr\n    secretMountPath: /home/service/keys\n    repository: git@github.com:th2-net/th2-demo-configuration.git\n    repositoryLocalCache: /home/service/repository\n    httpAuthUsername: \"\" #should be stored in secret th2-git-access-schemas \n    httpAuthPassword: \"\" #should be stored in secret th2-git-access-schemas\n  rabbitmq:\n    vHostPrefix: th2-\n    usernamePrefix: th2-user-\n    secret: rabbitmq\n    passwordLength: 24\n  cassandra:\n    keyspacePrefix: schema_\n    secret: cassandra\n  kubernetes:\n    namespacePrefix: \"th2-\" # must be not more than 5 symbols\n    ingress: ingress-rules\n    configMaps:\n      logging: logging-config-template\n      rabbitmq: rabbit-mq-app-config\n      rabbitmq-ext: rabbit-mq-external-app-config\n      cassandra: cradle\n      cassandra-ext: cradle-external\n      prometheus: prometheus-app-config\n    secrets:\n    - th2-core \n    - th2-solution\n    - th2-proprietary\n# ...\n```\n\n### Git authorization\n\n**infra-mgr** supports several ways of authorization on the git service:\n\n1. SSH key (default) - private SSH key should be stored in the special Kubernetes secret. With this key app is authorized on the git service.\n2. HTTP credentials - fill appropriate fields to authorize on the git service with your login and password.\n3. Personal access token - to authorize with your PAT, put it to `httpAuthUsername` field for GitHub or to  `httpAuthPassword` field for GitLab.\n\n### th2 environment\n\n`infra-mgr-config.yml` is a configuration file specifying the type of synchronization between Git and Kubernetes. \nThere are 4 synchronization options:\n\n1. `off` - No synchronization will be done;\n2. `deny` - No synchronization will be done and associated namespaces will be removed from Kubernetes;\n3. `sync` - Synchronizes repository changes with Kubernetes;\n4. `rule` - Synchronizes repository changes with Kubernetes, watches resource changes in it and brings those changes back to the repository state.\n\n<notice info>\n\nConfiguration is done in `infra-mgr-config.yml` for each th2 environment. \n\n</notice>\n\n```yaml\n# infra-mgr-config.yml\nkind: SettingsFile\nmetadata:\n  name: infra-mgr-config\nspec:\n  k8s-propagation: off\n  th2BoxConfig:\n    logging:\n      logLevelTh2: INFO\n      logLevelRoot: INFO\n    mqRouter:\n      connectionTimeout: \"-1\"\n      connectionCloseTimeout: \"10000\"\n      maxRecoveryAttempts: \"5\"\n      minConnectionRecoveryTimeout: \"10000\"\n      maxConnectionRecoveryTimeout: \"10000\"\n      prefetchCount: \"10\"\n    grpcRouter:\n      workers: \"5\"\n    cradleManager:\n      cradleMaxEventBatchSize: \"1048576\"\n      cradleMaxMessageBatchSize: \"1048576\"\n      timeout: \"5000\"\n      pageSize: \"5000\"\n```\n","fileInfo":{"path":"versions/1-7/infrastructure/infra-components/th2-infra-mgr.md"},"headings":[{"anchor":"#th2-infra-mgr","value":"th2-infra-mgr","depth":1},{"anchor":"#functionality","value":"Functionality","depth":2},{"anchor":"#infra-schema","value":"Infra schema","depth":3},{"anchor":"#kubernetes-cluster","value":"Kubernetes cluster","depth":3},{"anchor":"#cassandra","value":"Cassandra","depth":3},{"anchor":"#configuration","value":"Configuration","depth":2},{"anchor":"#th2-cluster","value":"th2 cluster","depth":3},{"anchor":"#git-authorization","value":"Git authorization","depth":3},{"anchor":"#th2-environment","value":"th2 environment","depth":3}],"read_before":[],"continue_learning":[],"terms":[],"related":[{"name":"th2-net/th2-infra","icon":"mdi-github","href":"https://github.com/th2-net/th2-infra"}],"hide_releases":null,"_githubRepository":{"html_url":"https://github.com/th2-net/th2-infra-mgr","language":"Java","description":"","updated_at":"2021-11-29T13:26:54Z","owner":{"html_url":"https://github.com/th2-net","avatar_url":"https://avatars.githubusercontent.com/u/73948563?v=4","login":"th2-net"},"releases":[{"id":"35714780","name":"0.10.5","tag_name":"v0.10.5","body":"","published_at":"2020-12-25T07:34:01Z"},{"id":"34686889","name":"","tag_name":"v0.9.1","body":"","published_at":"2020-12-02T11:56:53Z"},{"id":"34587087","name":"","tag_name":"v0.9.0","body":"","published_at":"2020-11-30T16:41:38Z"}]}}},"context":{}}